<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Compliance Filter - Professional Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-gray: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header p {
            color: var(--gray);
            font-size: 1rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .analysis-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .button-group {
            display: flex;
            gap: 1rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--gray);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-panel.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .threat-badge {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .threat-safe { background: #d1fae5; color: #065f46; }
        .threat-benign { background: #d1fae5; color: #065f46; }
        .threat-suspicious { background: #fef3c7; color: #92400e; }
        .threat-moderate { background: #fed7aa; color: #9a3412; }
        .threat-high { background: #fecaca; color: #991b1b; }
        .threat-critical { background: #fee2e2; color: #7f1d1d; }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .metric-card {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .info-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--light-gray);
        }

        .info-section h3 {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 0.75rem;
            letter-spacing: 0.5px;
        }

        .info-content {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--dark);
        }

        .technique-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .technique-tag {
            background: var(--primary);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stats-sidebar {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--gray);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            color: white;
            padding: 2rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .action-recommendation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: 600;
        }

        .detection-details {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--light-gray);
        }

        .detection-category {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .detection-category:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .detection-category.detected {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .detection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .detection-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .detection-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .detection-icon.safe {
            background: #d1fae5;
            color: #065f46;
        }

        .detection-icon.threat {
            background: #fee2e2;
            color: #991b1b;
        }

        .detection-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-detected {
            background: #fecaca;
            color: #991b1b;
        }

        .badge-clear {
            background: #d1fae5;
            color: #065f46;
        }

        .detection-body {
            font-size: 0.875rem;
            color: var(--gray);
            line-height: 1.6;
        }

        .detection-details-list {
            margin-top: 0.5rem;
            padding-left: 1.25rem;
        }

        .detection-details-list li {
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .confidence-bar {
            margin-top: 0.5rem;
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .jailbreak-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .jailbreak-section.critical {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left-color: #ef4444;
        }

        .jailbreak-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pattern-chip {
            display: inline-block;
            background: rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin: 0.25rem;
            font-size: 0.75rem;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                LLM Compliance Filter
            </h1>
            <p>Advanced AI Safety & Jailbreak Detection System</p>
            <div class="status-badge">
                <div class="status-indicator"></div>
                System Operational
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Analysis Panel -->
            <div class="analysis-panel">
                <div class="panel-header">Prompt Analysis</div>
                
                <div class="form-group">
                    <label for="promptInput">Enter Prompt for Analysis</label>
                    <textarea 
                        id="promptInput" 
                        placeholder="Type or paste the content you want to analyze for potential jailbreak attempts, policy violations, or security threats..."
                    ></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="analyzePrompt()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        Analyze Prompt
                    </button>
                    <button class="btn btn-secondary" onclick="clearForm()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Clear
                    </button>
                </div>

                <!-- Results Panel -->
                <div id="resultsPanel" class="results-panel">
                    <div class="panel-header">Analysis Results</div>
                    
                    <div id="threatBadge"></div>

                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Risk Score</div>
                            <div class="metric-value" id="riskScore">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Processing Time</div>
                            <div class="metric-value" id="processingTime">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Confidence</div>
                            <div class="metric-value" id="confidence">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Status</div>
                            <div class="metric-value" id="complianceStatus">-</div>
                        </div>
                    </div>

                    <div id="techniquesSection" class="info-section" style="display: none;">
                        <h3>Detected Techniques</h3>
                        <div id="techniquesList" class="technique-list"></div>
                    </div>

                    <div class="info-section">
                        <h3>Analysis Explanation</h3>
                        <div id="explanation" class="info-content"></div>
                    </div>

                    <div id="recommendationSection" class="action-recommendation">
                        <strong>Recommended Action:</strong> <span id="recommendation"></span>
                    </div>

                    <div id="detectionDetailsSection" class="detection-details" style="display: none;">
                        <h3>Detection Breakdown</h3>
                        <div id="detectionCategories"></div>
                    </div>
                </div>
            </div>

            <!-- Stats Sidebar -->
            <div class="stats-sidebar">
                <div class="panel-header">System Statistics</div>
                
                <div class="stat-item">
                    <div class="stat-label">Total Analyzed</div>
                    <div class="stat-value" id="totalRequests">0</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">Threats Blocked</div>
                    <div class="stat-value" id="threatsBlocked">0</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">Safe Content</div>
                    <div class="stat-value" id="safeContent">0</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">System Uptime</div>
                    <div class="stat-value" id="uptime">-</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Advanced LLM Compliance Filter ‚Ä¢ Production-Ready AI Safety System</p>
            <p style="margin-top: 0.5rem; opacity: 0.7;">Real-time detection ‚Ä¢ Multi-layer analysis ‚Ä¢ Enterprise-grade security</p>
        </div>
    </div>

    <script>
        // Update stats on page load
        updateStats();
        setInterval(updateStats, 5000); // Update every 5 seconds

        async function analyzePrompt() {
            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a prompt to analyze');
                return;
            }

            const analyzeBtn = document.querySelector('.btn-primary');
            const originalText = analyzeBtn.innerHTML;
            
            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading-spinner"></div> Analyzing...';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayResults(result);
                } else {
                    alert('Analysis failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = originalText;
            }
        }

        function displayResults(analysis) {
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.classList.add('show');

            // Threat badge
            const threatBadge = document.getElementById('threatBadge');
            const threatLevel = analysis.threat_level || 'safe';
            threatBadge.className = `threat-badge threat-${threatLevel}`;
            threatBadge.textContent = threatLevel.toUpperCase();

            // Metrics
            document.getElementById('riskScore').textContent = (analysis.overall_risk_score * 100).toFixed(1) + '%';
            document.getElementById('processingTime').textContent = (analysis.processing_time_ms || 0).toFixed(1) + 'ms';
            
            // Get jailbreak confidence from detections
            const jbDetection = analysis.detections && analysis.detections.jailbreak;
            const confidence = jbDetection ? (jbDetection.confidence * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('confidence').textContent = confidence;
            document.getElementById('complianceStatus').textContent = analysis.is_compliant ? '‚úì Pass' : '‚úó Fail';

            // Techniques
            const techniquesSection = document.getElementById('techniquesSection');
            const techniquesList = document.getElementById('techniquesList');
            
            if (jbDetection && jbDetection.detected && jbDetection.techniques && jbDetection.techniques.length > 0) {
                techniquesSection.style.display = 'block';
                techniquesList.innerHTML = jbDetection.techniques
                    .map(t => `<span class="technique-tag">${t.replace(/_/g, ' ').toUpperCase()}</span>`)
                    .join('');
            } else {
                techniquesSection.style.display = 'none';
            }

            // Build dynamic explanation based on all violations
            const explanation = buildDynamicExplanation(analysis);
            document.getElementById('explanation').innerHTML = explanation;

            // Build dynamic recommendations
            const recommendations = buildDynamicRecommendations(analysis);
            document.getElementById('recommendation').innerHTML = recommendations;

            // Display detailed detection breakdown
            displayDetectionBreakdown(analysis);

            // Update stats after analysis
            updateStats();
        }

        function buildDynamicExplanation(analysis) {
            let explanations = [];
            
            // If compliant, return positive message
            if (analysis.is_compliant) {
                return '‚úÖ <strong>Analysis Complete:</strong> The submitted content has been thoroughly analyzed across multiple detection systems including jailbreak detection, privacy screening, context-specific threat analysis, and semantic toxicity evaluation. No policy violations or security concerns were identified. This content is safe to process.';
            }
            
            // Hate Speech Detection Explanation
            const hateDetection = analysis.detections && analysis.detections.hate_speech;
            if (hateDetection && hateDetection.detected) {
                const severity = hateDetection.severity || 'high';
                let hateExplanation = `<div style="margin-bottom: 1rem;"><strong>‚ö†Ô∏è Hate Speech Detected:</strong> `;
                
                hateExplanation += `Content identified as hate speech with ${(hateDetection.confidence * 100).toFixed(1)}% confidence. `;
                
                if (hateDetection.explanation) {
                    hateExplanation += hateDetection.explanation;
                } else {
                    hateExplanation += 'This content promotes hatred, discrimination, or violence against individuals or groups based on protected characteristics.';
                }
                hateExplanation += `</div>`;
                explanations.push(hateExplanation);
            }
            
            // Jailbreak Detection Explanation
            const jbDetection = analysis.detections && analysis.detections.jailbreak;
            if (jbDetection && jbDetection.detected) {
                const severity = jbDetection.severity || 'low';
                let jbExplanation = `<div style="margin-bottom: 1rem;"><strong>üîí Jailbreak Attempt Detected:</strong> `;
                
                if (severity === 'critical') {
                    jbExplanation += `Critical severity jailbreak attempt identified with ${(jbDetection.confidence * 100).toFixed(0)}% confidence. `;
                } else if (severity === 'high') {
                    jbExplanation += `High-risk jailbreak patterns detected with ${(jbDetection.confidence * 100).toFixed(0)}% confidence. `;
                } else if (severity === 'moderate') {
                    jbExplanation += `Moderate jailbreak indicators found with ${(jbDetection.confidence * 100).toFixed(0)}% confidence. `;
                } else {
                    jbExplanation += `Low-level jailbreak patterns detected with ${(jbDetection.confidence * 100).toFixed(0)}% confidence. `;
                }
                
                if (jbDetection.explanation) {
                    jbExplanation += jbDetection.explanation;
                }
                jbExplanation += `</div>`;
                explanations.push(jbExplanation);
            }
            
            // Context-Specific Threats Explanation
            if (analysis.context_threats && analysis.context_threats.length > 0) {
                const threats = analysis.context_threats;
                let threatExplanation = `<div style="margin-bottom: 1rem;"><strong>üö® Context-Specific Threats:</strong> Detected ${threats.length} specific threat${threats.length > 1 ? 's' : ''}: `;
                
                const threatDescriptions = threats.map(t => {
                    const category = t.category.replace(/_/g, ' ');
                    return `<strong>${category}</strong> (${t.severity} severity, ${t.indicators} indicator${t.indicators > 1 ? 's' : ''})`;
                });
                
                threatExplanation += threatDescriptions.join(', ') + '. ';
                threatExplanation += 'These patterns indicate content that may pose safety risks or violate content policies.</div>';
                explanations.push(threatExplanation);
            }
            
            // Privacy Violations Explanation
            const privacy = analysis.detections && analysis.detections.privacy;
            if (privacy && privacy.detected && privacy.violations && privacy.violations.length > 0) {
                let privacyExplanation = `<div style="margin-bottom: 1rem;"><strong>üîí Privacy Violations:</strong> `;
                
                const piiTypes = [...new Set(privacy.violations.map(v => v.category))];
                privacyExplanation += `Identified ${privacy.violations.length} piece${privacy.violations.length > 1 ? 's' : ''} of personally identifiable information (PII): ${piiTypes.join(', ')}. `;
                privacyExplanation += `Privacy risk level: <strong>${privacy.risk_level.toUpperCase()}</strong> with a privacy score of ${(privacy.privacy_score * 100).toFixed(0)}%. `;
                
                if (privacy.explanation) {
                    privacyExplanation += privacy.explanation;
                } else {
                    privacyExplanation += 'This sensitive data should be redacted or masked before processing to comply with privacy regulations.';
                }
                privacyExplanation += `</div>`;
                explanations.push(privacyExplanation);
            }
            
            // OpenAI Moderation Explanation
            const openai = analysis.detections && analysis.detections.openai;
            if (openai && openai.flagged && openai.flagged_categories && openai.flagged_categories.length > 0) {
                let openaiExplanation = `<div style="margin-bottom: 1rem;"><strong>üõ°Ô∏è OpenAI Moderation:</strong> `;
                openaiExplanation += `Content flagged by OpenAI's industry-standard moderation system for: ${openai.flagged_categories.join(', ')}. `;
                
                if (openai.highest_risk_category && openai.highest_risk_score) {
                    openaiExplanation += `Highest risk category: <strong>${openai.highest_risk_category}</strong> (${(openai.highest_risk_score * 100).toFixed(0)}% confidence).`;
                }
                openaiExplanation += `</div>`;
                explanations.push(openaiExplanation);
            }
            
            // Token Anomalies Explanation
            const tokenAnomalies = analysis.detections && analysis.detections.token_anomalies;
            if (tokenAnomalies && tokenAnomalies.detected) {
                let tokenExplanation = `<div style="margin-bottom: 1rem;"><strong>üîç Token Anomalies:</strong> `;
                tokenExplanation += `Detected ${tokenAnomalies.anomalies.length} token anomal${tokenAnomalies.anomalies.length > 1 ? 'ies' : 'y'}. `;
                tokenExplanation += 'The content contains unusual character patterns, encoding tricks, or obfuscation techniques that may be attempting to bypass content filters.</div>';
                explanations.push(tokenExplanation);
            }
            
            // Semantic Toxicity Explanation
            const semantic = analysis.detections && analysis.detections.semantic_analysis;
            if (semantic && semantic.is_toxic) {
                let semanticExplanation = `<div style="margin-bottom: 1rem;"><strong>‚ò£Ô∏è Semantic Toxicity:</strong> `;
                semanticExplanation += `Content identified as toxic with ${(semantic.confidence * 100).toFixed(0)}% confidence. `;
                if (semantic.explanation) {
                    semanticExplanation += semantic.explanation;
                }
                semanticExplanation += `</div>`;
                explanations.push(semanticExplanation);
            }
            
            // Combined summary
            if (explanations.length > 0) {
                return explanations.join('');
            }
            
            // Fallback
            return '<div>‚ÑπÔ∏è Content flagged for review but specific violation details are not available. Manual review recommended.</div>';
        }

        function buildDynamicRecommendations(analysis) {
            let recommendations = [];
            
            // Check if content is compliant
            if (analysis.is_compliant) {
                return '<strong>‚úÖ ALLOW:</strong> Content is compliant and safe to process. No policy violations detected.';
            }
            
            // Hate Speech Detection
            const hateDetection = analysis.detections && analysis.detections.hate_speech;
            if (hateDetection && hateDetection.detected) {
                const confidence = (hateDetection.confidence * 100).toFixed(1);
                recommendations.push(`üö´ <strong>BLOCK IMMEDIATELY:</strong> Hate speech detected with ${confidence}% confidence. Content promotes hatred or discrimination.`);
            }
            
            // Jailbreak Detection
            const jbDetection = analysis.detections && analysis.detections.jailbreak;
            if (jbDetection && jbDetection.detected) {
                const severity = jbDetection.severity || 'low';
                if (severity === 'critical') {
                    recommendations.push('üö´ <strong>BLOCK IMMEDIATELY:</strong> Critical jailbreak attempt detected. Do not process this request.');
                } else if (severity === 'high') {
                    recommendations.push('‚õî <strong>BLOCK:</strong> High-risk jailbreak attempt. Reject this request and log the attempt.');
                } else if (severity === 'moderate') {
                    recommendations.push('‚ö†Ô∏è <strong>FLAG:</strong> Moderate jailbreak risk detected. Review before processing.');
                } else {
                    recommendations.push('‚ö° <strong>CAUTION:</strong> Low-level jailbreak indicators detected. Monitor this request.');
                }
            }
            
            // Context-Specific Threats
            if (analysis.context_threats && analysis.context_threats.length > 0) {
                const threats = analysis.context_threats;
                threats.forEach(threat => {
                    const category = threat.category.replace(/_/g, ' ').toLowerCase();
                    if (threat.severity === 'critical' || threat.severity === 'high') {
                        recommendations.push(`üö® <strong>BLOCK:</strong> ${category} detected with ${threat.severity} severity. Immediate action required.`);
                    } else {
                        recommendations.push(`‚ö†Ô∏è <strong>REVIEW:</strong> Potential ${category} detected. Manual review recommended.`);
                    }
                });
            }
            
            // Privacy Violations
            const privacy = analysis.detections && analysis.detections.privacy;
            if (privacy && privacy.detected && privacy.violations && privacy.violations.length > 0) {
                const violationTypes = [...new Set(privacy.violations.map(v => v.category))];
                if (privacy.risk_level === 'high' || privacy.risk_level === 'critical') {
                    recommendations.push(`üîí <strong>REDACT:</strong> High-risk privacy violations detected (${violationTypes.join(', ')}). Remove or mask PII before processing.`);
                } else {
                    recommendations.push(`üìã <strong>SANITIZE:</strong> PII detected (${violationTypes.join(', ')}). Consider anonymizing data.`);
                }
            }
            
            // OpenAI Moderation
            const openai = analysis.detections && analysis.detections.openai;
            if (openai && openai.flagged && openai.flagged_categories && openai.flagged_categories.length > 0) {
                const categories = openai.flagged_categories.map(c => c.replace(/\//g, '/')).join(', ');
                recommendations.push(`üõ°Ô∏è <strong>FILTER:</strong> Content flagged by OpenAI moderation for: ${categories}. Apply content filtering.`);
            }
            
            // Token Anomalies
            const tokenAnomalies = analysis.detections && analysis.detections.token_anomalies;
            if (tokenAnomalies && tokenAnomalies.detected) {
                recommendations.push('üîç <strong>INSPECT:</strong> Token anomalies detected. Content may contain obfuscation techniques.');
            }
            
            // Overall Risk Score based recommendation
            if (analysis.overall_risk_score > 0.8) {
                recommendations.push(`‚ö° <strong>HIGH RISK:</strong> Overall risk score ${(analysis.overall_risk_score * 100).toFixed(0)}%. Strong action recommended.`);
            } else if (analysis.overall_risk_score > 0.5) {
                recommendations.push(`‚ö° <strong>MODERATE RISK:</strong> Overall risk score ${(analysis.overall_risk_score * 100).toFixed(0)}%. Enhanced monitoring suggested.`);
            }
            
            // If we have recommendations from the backend, include them too
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                analysis.recommendations.forEach(rec => {
                    if (!recommendations.some(r => r.includes(rec))) {
                        recommendations.push('üí° ' + rec);
                    }
                });
            }
            
            // Default if no specific recommendations
            if (recommendations.length === 0) {
                return '<strong>‚ÑπÔ∏è INFO:</strong> Content flagged but no specific violations identified. Manual review suggested.';
            }
            
            return recommendations.join('<br>');
        }

        function displayDetectionBreakdown(analysis) {
    const detectionSection = document.getElementById('detectionDetailsSection');
    const categoriesContainer = document.getElementById('detectionCategories');
    
    let violationsHTML = '';
    let violationCount = 0;
    
    // Hate Speech Detection
    const hate = (analysis.detections && analysis.detections.hate_speech) || {};
    if (hate.detected) {
        violationCount++;
        const severity = hate.severity || 'high';
        const config = { icon: '‚ö†Ô∏è', color: '#dc2626', bgGradient: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', borderColor: '#ef4444' };
        
        violationsHTML += `
            <div style="background: ${config.bgGradient}; border-left: 4px solid ${config.borderColor}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: ${config.color};">
                    ${config.icon} Hate Speech Detected - ${severity.toUpperCase()} Severity
                </h4>
                <p><strong>Confidence:</strong> ${(hate.confidence * 100).toFixed(1)}%</p>
                ${hate.patterns && hate.patterns.length > 0 ? `
                    <p style="margin-top: 0.75rem;"><strong>Matched Patterns:</strong></p>
                    <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        ${hate.patterns.map(p => `<span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-family: monospace;">${p}</span>`).join('')}
                    </div>
                ` : ''}
                <p style="margin-top: 1rem; font-size: 0.875rem; line-height: 1.6; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1rem;">${hate.explanation || 'Content promotes hatred, discrimination, or violence against individuals or groups.'}</p>
            </div>
        `;
    }
    
    // Jailbreak Detection
    const jb = (analysis.detections && analysis.detections.jailbreak) || {};
    if (jb.detected) {
        violationCount++;
        const severity = jb.severity || 'low';
        const severityConfig = {
            'critical': { icon: '‚ò†Ô∏è', color: '#dc2626', bgGradient: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', borderColor: '#ef4444' },
            'high': { icon: 'üö®', color: '#ea580c', bgGradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)', borderColor: '#f97316' },
            'moderate': { icon: '‚ö†Ô∏è', color: '#d97706', bgGradient: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderColor: '#f59e0b' },
            'low': { icon: 'üí°', color: '#0891b2', bgGradient: 'linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%)', borderColor: '#06b6d4' }
        };
        const config = severityConfig[severity] || severityConfig['low'];
        
        violationsHTML += `
            <div style="background: ${config.bgGradient}; border-left: 4px solid ${config.borderColor}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: ${config.color};">
                    ${config.icon} Jailbreak Detection - ${severity.toUpperCase()} Severity
                </h4>
                <p><strong>Confidence:</strong> ${(jb.confidence * 100).toFixed(1)}%</p>
                ${jb.techniques && jb.techniques.length > 0 ? `
                    <p style="margin-top: 0.5rem;"><strong>Techniques:</strong></p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        ${jb.techniques.map(t => `<span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${t.replace(/_/g, ' ').toUpperCase()}</span>`).join('')}
                    </div>
                ` : ''}
                ${jb.patterns && jb.patterns.length > 0 ? `
                    <p style="margin-top: 0.75rem;"><strong>Matched Patterns:</strong></p>
                    <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        ${jb.patterns.map(p => `<span style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-family: monospace;">${p}</span>`).join('')}
                    </div>
                ` : ''}
                <p style="margin-top: 1rem; font-size: 0.875rem; line-height: 1.6; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1rem;">${jb.explanation}</p>
            </div>
        `;
    }
    
    // Context-Specific Threats
    const threats = analysis.context_threats || [];
    if (threats.length > 0) {
        violationCount++;
        const severityLevels = { 'critical': 4, 'high': 3, 'moderate': 2, 'low': 1 };
        let highestSeverity = 'low';
        threats.forEach(t => {
            if (severityLevels[t.severity] > severityLevels[highestSeverity]) {
                highestSeverity = t.severity;
            }
        });
        const severityColors = { 'critical': '#dc2626', 'high': '#ea580c', 'moderate': '#f59e0b', 'low': '#06b6d4' };
        const sevIcons = { 'critical': '‚ò†Ô∏è', 'high': 'üî•', 'moderate': '‚ö†Ô∏è', 'low': 'üí°' };
        const borderColor = severityColors[highestSeverity];
        const mainIcon = sevIcons[highestSeverity];
        
        violationsHTML += `
            <div style="background: ${borderColor}08; border-left: 4px solid ${borderColor}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: ${borderColor};">
                    üö® Context-Specific Threats Detected (${threats.length})
                </h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${threats.map(t => {
                        const color = severityColors[t.severity];
                        const icon = sevIcons[t.severity];
                        return `
                            <div style="background: white; border-left: 3px solid ${color}; padding: 0.75rem; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.1rem;">${icon}</span>
                                    <strong style="color: ${color};">${t.category.replace(/_/g, ' ').toUpperCase()}</strong>
                                </div>
                                <p style="margin: 0; font-size: 0.875rem; color: #4b5563;">
                                    <strong>Severity:</strong> ${t.severity.toUpperCase()} | 
                                    <strong>Indicators:</strong> ${t.indicators}
                                </p>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Privacy Violations
    const privacy = (analysis.detections && analysis.detections.privacy) || {};
    if (privacy.detected && privacy.violations && privacy.violations.length > 0) {
        violationCount++;
        const riskLevel = privacy.risk_level || 'low';
        const riskConfig = {
            'critical': { color: '#dc2626', icon: 'üö´', bg: '#fee2e2' },
            'high': { color: '#ea580c', icon: 'üîí', bg: '#fed7aa' },
            'medium': { color: '#f59e0b', icon: '‚ö†Ô∏è', bg: '#fef3c7' },
            'low': { color: '#06b6d4', icon: 'üõà', bg: '#cffafe' }
        };
        const config = riskConfig[riskLevel] || riskConfig['low'];
        
        violationsHTML += `
            <div style="background: ${config.bg}; border-left: 4px solid ${config.color}; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: ${config.color};">
                    ${config.icon} Privacy Violations Detected (${privacy.violations.length})
                </h4>
                <p><strong style="color: ${config.color};">Risk Level:</strong> ${riskLevel.toUpperCase()}</p>
                <p><strong>Privacy Score:</strong> ${(privacy.privacy_score * 100).toFixed(1)}%</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                    ${privacy.violations.map(v => {
                        const categoryIcons = {
                            'EMAIL': 'üìß', 'PHONE': 'üìû', 'SSN': 'üÜî', 'CREDIT_CARD': 'üí≥',
                            'ADDRESS': 'üè†', 'NAME': 'üë§', 'IP_ADDRESS': 'üåê', 'DATE_OF_BIRTH': 'üéÇ'
                        };
                        const icon = categoryIcons[v.category] || 'üîí';
                        const confidence = (v.confidence * 100).toFixed(0);
                        const confColor = confidence > 80 ? '#dc2626' : confidence > 60 ? '#f59e0b' : '#06b6d4';
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.1rem;">${icon}</span>
                                    <strong>${v.category.replace(/_/g, ' ')}:</strong>
                                    <code style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${v.masked_value}</code>
                                </div>
                                <span style="background: ${confColor}15; color: ${confColor}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${confidence}%</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Token Anomalies
    const tokenAnomalies = (analysis.detections && analysis.detections.token_anomalies) || {};
    if (tokenAnomalies.detected) {
        violationCount++;
        violationsHTML += `
            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: #d97706;">
                    üîç Token Anomalies Detected (${tokenAnomalies.anomalies.length})
                </h4>
                <p><strong>Anomaly Score:</strong> ${(tokenAnomalies.score * 100).toFixed(1)}%</p>
                <p style="margin-top: 0.5rem;">Detected unusual patterns, encoding tricks, or obfuscation techniques that may be attempting to bypass content filters.</p>
                ${tokenAnomalies.anomalies && tokenAnomalies.anomalies.length > 0 ? `
                    <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        ${tokenAnomalies.anomalies.slice(0, 5).map(a => `
                            <span style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-family: monospace;">${a.type || 'anomaly'}</span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // Semantic Toxicity
    const sem = (analysis.detections && analysis.detections.semantic_analysis) || {};
    if (sem.is_toxic) {
        violationCount++;
        violationsHTML += `
            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: #dc2626;">
                    ‚ò£Ô∏è Semantic Toxicity Detected
                </h4>
                <p><strong>Confidence:</strong> ${(sem.confidence * 100).toFixed(1)}%</p>
                ${sem.explanation ? `<p style="margin-top: 0.5rem;">${sem.explanation}</p>` : ''}
            </div>
        `;
    }
    
    // OpenAI Moderation
    const mod = (analysis.detections && analysis.detections.openai) || {};
    if (mod.flagged && mod.flagged_categories && mod.flagged_categories.length > 0) {
        violationCount++;
        violationsHTML += `
            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: #2563eb;">
                    üõ°Ô∏è OpenAI Moderation Flagged
                </h4>
                <p><strong>Flagged Categories:</strong></p>
                <ul style="margin: 0.5rem 0 0 1.25rem;">
                    ${mod.flagged_categories.map(cat => `<li style="margin-bottom: 0.25rem;">${cat.toUpperCase()}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // Display results
    if (violationCount > 0) {
        categoriesContainer.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <h3 style="margin: 0 0 1.5rem 0; font-size: 1.25rem; font-weight: 700; color: #1f2937;">
                    ${violationCount} Violation${violationCount > 1 ? 's' : ''} Detected
                </h3>
                ${violationsHTML}
            </div>
        `;
        detectionSection.style.display = 'block';
    } else {
        categoriesContainer.innerHTML = `
            <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; color: #065f46;">
                    ‚úÖ No Violations Detected
                </h4>
                <p style="margin: 0.5rem 0 0 0; color: #047857;">Content passed all security and compliance checks.</p>
            </div>
        `;
        detectionSection.style.display = 'block';
    }
}


        function clearForm() {
            document.getElementById('promptInput').value = '';
            document.getElementById('resultsPanel').classList.remove('show');
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                document.getElementById('totalRequests').textContent = data.total_processed || 0;
                document.getElementById('threatsBlocked').textContent = data.jailbreak_attempts || 0;
                const safeContent = (data.total_processed || 0) - (data.jailbreak_attempts || 0);
                document.getElementById('safeContent').textContent = safeContent;
                document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds || 0);
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        function formatUptime(seconds) {
            if (seconds < 60) return seconds.toFixed(0) + 's';
            if (seconds < 3600) return (seconds / 60).toFixed(0) + 'm';
            return (seconds / 3600).toFixed(1) + 'h';
        }

        // Allow Enter to submit (Ctrl+Enter for new line)
        document.getElementById('promptInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                analyzePrompt();
            }
        });
    </script>
</body>
</html>